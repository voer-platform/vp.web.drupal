<?php

/**
 * Implements hook_block_info().
 * @return [type] [description]
 */
function voer_blocks_block_info(){
  // This example comes from node.module.
  $blocks['voer_categories_block'] = array(
    'info' => t('VOER - Categories'),
  );

  $blocks['voer_modules_block'] = array(
    'info' => t('VOER - Featured modules'),
  );

  $blocks['voer_collections_block'] = array(
    'info' => t('VOER - Featured collections'),
  );

  $blocks['voer_courses_block'] = array(
    'info' => t('VOER - Featured courses'),
  );

  $blocks['voer_questionaire_block'] = array(
    'info' => t('VOER - Questionnaire'),
  );

  $blocks['voer_help_support_block'] = array(
    'info' => t('VOER - Help & Support'),
  );

  $blocks['voer_featured_author_block'] = array(
    'info' => t('VOER - Featured authors'),
  );

  $blocks['voer_statistics'] = array(
    'info' => t('VOER - Statistics'),
  );

  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function voer_blocks_block_view($delta='') {
  $block = array();

  switch($delta) {
    case 'voer_categories_block' :
      $block['content'] = voer_categories_block_view($delta);
      break;
    case 'voer_modules_block' :
      $block['content'] = voer_modules_block_view($delta);
      break;
    case 'voer_collections_block' :
      $block['content'] = voer_collections_block_view($delta);
      break;
    case 'voer_courses_block' :
      $block['content'] = voer_courses_block_view($delta);
      break;
    case 'voer_questionaire_block' :
      $block['content'] = voer_questionaires_block_view($delta);
      break;
    case 'voer_help_support_block' :
      $block['content'] = voer_help_supports_block_view($delta);
      break;
    case 'voer_featured_author_block' :
      $block['content'] = voer_featured_authors_block_view($delta);
      break;
    case 'voer_statistics' :
      $block['content'] = voer_statistics($delta);
      break;
  }

  return $block;
}

function voer_blocks_block_configure($delta = ""){
  $form = array();
  switch ($delta){
    case 'voer_categories_block' :
    case 'voer_modules_block' :
    case 'voer_collections_block' :
    case 'voer_courses_block' :
    case 'voer_questionaire_block' :
    case 'voer_help_support_block' :
      $form[$delta . "_material_id"] = array(
        '#type' => 'textfield',
        '#title' => t('Material ID'),
        '#size' => 60,
        '#description' => t('Get material id for show content in block.'),
        '#default_value' => variable_get($delta . "_material_id", "")
      );
      break;
  }
  if ($delta == 'voer_modules_block' || $delta == 'voer_collections_block' || $delta == 'voer_courses_block' || $delta == 'voer_questionaire_block' || $delta == 'voer_help_support_block' || $delta == 'voer_featured_author_block') {
    $form[$delta . '_voer_block_title'] = array(
        '#type' => 'textfield',
        '#title' => t('Type'),
        '#size' => 60,
        '#description' => t('Set type of block.'),
        '#default_value' => variable_get($delta . "_voer_block_title", "")
      );
  }
  return $form;
}

function voer_blocks_block_save($delta = "", $edit = array()){
  switch ($delta){
    case 'voer_categories_block' :
    case 'voer_modules_block' :
    case 'voer_collections_block' :
    case 'voer_courses_block' :
    case 'voer_questionaire_block' :
    case 'voer_help_support_block' :
      variable_set($delta . "_material_id", $edit[$delta . "_material_id"]);
      variable_set($delta . "_voer_block_title", $edit[$delta . "_voer_block_title"]);
      break;
  }
  return;
}

function voer_categories_block_view($delta = ""){
  $output = array();

  module_load_include('inc', 'voer_api');
  try {
    $categories = voer_api_get_all_categories();
    // dpm($categories);
    $list = array();
    if (isset($categories)){
      foreach ($categories as $category) {
        //Chi lay nhung category co so bai viet > 0
        $catinfo = voer_api_get_category($category->id, TRUE);
        $total = $catinfo->material; //Lay so luong material
        if ($total > 0){
          $list[$category->id] = l($category->name . " ($total)", 'category/' . $category->id, array('class' => 'category-link'));
        }
      }
    }

    // Block output in HTML with div wrapper
    $output[] = array(
      '#theme' => 'item_list',
      '#items' => $list,
      '#attributes' => array('class' => 'category_list span6'),
    );

    return $output;
  } catch (Exception $e) {
    return "";
  }
}

function voer_modules_block_view($delta = "")
{
  //Fix module_id
  $module_id = variable_get($delta . "_material_id", "");
  $voer_block_title = variable_get($delta . "_voer_block_title", "Module");

  module_load_include('inc', 'voer_api');
  try {
    $module_list = voer_api_get_all_materials();

    $module = (array)voer_api_get_detail_material($module_id);
    $module['content_type'] = $voer_block_title;
    $module['total_count'] = $module_list->count;
    $module['image_path'] = drupal_get_path('module', 'voer_blocks') . '/images/default_module_image.jpg';

    $category = (array)voer_api_get_category($module['categories']);

    if ($category) {
      $module['category_name'] = $category['name'];
    }

    return theme('voer_module_custom', $module);

  } catch (Exception $e) {
    return "";
  }
}

function voer_collections_block_view($delta = "")
{
  //Fix module_id
  $module_id = variable_get($delta . "_material_id", "");
  $voer_block_title = variable_get($delta . "_voer_block_title", 'Collection');

  module_load_include('inc', 'voer_api');
  try {
    $module_list = voer_api_get_all_materials(VOER_MATERIAL_TYPE_COLLECTION);

    $module = (array)voer_api_get_detail_material($module_id);
    $module['content_type'] = $voer_block_title;
    $module['total_count'] = $module_list->count;
    $module['image_path'] = drupal_get_path('module', 'voer_blocks') . '/images/default_collection_image.jpg';

    $category = (array)voer_api_get_category($module['categories']);

    if ($category) {
      $module['category_name'] = $category['name'];
    }

    return theme('voer_collection_custom', $module);

  } catch (Exception $e) {
    return "";
  }
}

function voer_questionaires_block_view($delta = "")
{
  //Fix module_id
  $module_id = variable_get($delta . "_material_id", "");
  $voer_block_title = variable_get($delta . "_voer_block_title", 'Exams & Questions Bank');

  module_load_include('inc', 'voer_api');
  try {

    $module = (array)voer_api_get_detail_material($module_id);
    $module['content_type'] = $voer_block_title;
    $module['total_count'] = 0;
    $module['image_path'] = drupal_get_path('module', 'voer_blocks') . '/images/default_questionaire_image.jpg';

    $category = (array)voer_api_get_category($module['categories']);

    if ($category) {
      $module['category_name'] = $category['name'];
    }

    return theme('voer_questionaires_custom', $module);

  } catch (Exception $e) {
    return "";
  }
}

function voer_help_supports_block_view($delta = "")
{
  //Fix module_id
  $module_id = variable_get($delta . "_material_id", "");
  $voer_block_title = variable_get($delta . "_voer_block_title", 'Help & Support');

  module_load_include('inc', 'voer_api');
  try {
    $module_list = voer_api_get_all_materials();

    $module = (array)voer_api_get_detail_material($module_id);
    $module['content_type'] = $voer_block_title;
    $module['total_count'] = $module_list->count;
    $module['image_path'] = drupal_get_path('module', 'voer_blocks') . '/images/default_help_support_image.jpg';

    $category = (array)voer_api_get_category($module['categories']);

    if ($category) {
      $module['category_name'] = $category['name'];
    }

    return theme('voer_help_custom', $module);

  } catch (Exception $e) {
    return "";
  }
}

function voer_courses_block_view($delta = "")
{
  //Fix module_id
  $module_id = variable_get($delta . "_material_id", "");
  $voer_block_title = variable_get($delta . "_voer_block_title", 'Courseware');

  module_load_include('inc', 'voer_api');
  try {

    $module = (array)voer_api_get_detail_material($module_id);
    $module['content_type'] = $voer_block_title;
    $module['total_count'] = 0;
    $module['image_path'] = drupal_get_path('module', 'voer_blocks') . '/images/default_courseware_image.jpg';

    $category = (array)voer_api_get_category($module['categories']);

    if ($category) {
      $module['category_name'] = $category['name'];
    }

    return theme('voer_course_custom', $module);

  } catch (Exception $e) {
    return "";
  }
}

function voer_featured_authors_block_view($delta = "")
{
  module_load_include('inc', 'voer_api');
  $author_list = (array)voer_api_get_all_authors();
  $voer_block_title = variable_get($delta . "_voer_block_title", 'Featured authors');

  if (!isset($author_list['detail'])) {
    $author = array();
    $author['sub_title'] = $voer_block_title;
    $author['total_count'] = $author_list['count'];

    $max_range = 9;

    if ($author_list['count'] - 1 < 9) {
      $max_range = $author_list['count'] - 1;
    }

    $randomAuthor = rand(0, $max_range);
    foreach ($author_list['results'][$randomAuthor] as $key => $value) {
      if ($key == 'id') {
        $key = 'author_id';
        $author_id = $value;
      }
      $author[$key] = $value;
    }

    if ($author_id) {
      $materials = voer_api_get_materials_by_authors(array(50));
      $author['material_count'] = $materials->count;

      //fixed
      $result = voer_api_get_author(50);
      $author['fullname'] = $result->fullname;
      $author['author_id'] = $result->id;
    }

    return theme('voer_module_featured_author', $author);

  } else {
    return "";
  }
}

/**
* Implemtnation of hook_theme()
*/
function voer_blocks_theme($existing, $type, $theme, $path) {
  return array(
    'voer_collection_custom' => array(
      'arguments' => array('module' => array()),
      'template' => 'templates/block--voer-collection--view',
    ),
    'voer_module_custom' => array(
      'arguments' => array('module' => array()),
      'template' => 'templates/block--voer-module',
    ),
    'voer_course_custom' => array(
      'arguments' => array('module' => array()),
      'template' => 'templates/block--voer-courses--view',
    ),
    'voer_questionaires_custom' => array(
      'arguments' => array('module' => array()),
      'template' => 'templates/block--voer-questionaires--view',
    ),
    'voer_help_custom' => array(
      'arguments' => array('module' => array()),
      'template' => 'templates/block--voer-help--view',
    ),
    'voer_module_featured_author' => array(
      'arguments' => array('author' => array()),
      'render element' => 'element',
      'template' => 'templates/block--voer-featured-author--view',
    ),
  );
}

function voer_statistics($delta = '')
{
  module_load_include('inc', 'voer_api');
  $module_list = voer_api_get_all_materials();
  $collection_list = voer_api_get_all_materials(VOER_MATERIAL_TYPE_COLLECTION);
  $author_list = voer_api_get_all_authors();

  $output = '<h3>'. $module_list->count .' collections</h3>';
  $output .= '<h3>'. $collection_list->count .' modules</h3>';
  $output .= '<h3>'. $author_list->count .' authors</h3>';

  return $output;
}